var IMHWPB=IMHWPB||{};window.BOLDGRID=window.BOLDGRID||{},BOLDGRID.EDITOR=BOLDGRID.EDITOR||{};var BG=BOLDGRID.EDITOR;IMHWPB.Editor=function(e){var t=this;this.media_default_bound=!1;var n=e(window);this.row_selector_string="",this.content_selector_string="",this.column_selector_string="",this.currently_selected_size=null,this.select_alignment=function(){var n=e(tinymce.activeEditor.selection.getNode()),i=e(".attachments-browser select.alignment"),a=e(".attachments-browser select.link-to");if(0==t.media_default_bound&&(t.media_default_bound=!0,wp.media.frame.on("open",t.select_alignment)),n.is("img")){var s=[];n.attr("class")&&(s=n.attr("class").split(/\s+/));var o="none";e.each(s,function(e,t){return"aligncenter"==t?(o="center",!1):"alignnone"==t?(o="none",!1):"alignright"==t?(o="right",!1):"alignleft"==t?(o="left",!1):void 0});var r=null;n.parent("a").length||(r="none"),a.length&&r&&a.val(r).change(),i.length&&i.val(o).change()}},this.select_default_alignment=function(){e(document).on("click",".attachments-browser .attachment",t.select_alignment)},this.draggable=function(){var e=null;return IMHWPB.WP_MCE_Draggable&&IMHWPB.WP_MCE_Draggable.instance&&(e=IMHWPB.WP_MCE_Draggable.instance.draggable_instance),e},this.override_insert_media=function(){var t;_.isUndefined(window.send_to_editor)||(t=send_to_editor),send_to_editor=function(n){var i=[];if(!n.match(/^\[.+?\]/))var a=e(tinymce.activeEditor.selection.getContent()),s=e(n),o=s.is("img")||s.is("a")&&s.find("*").is("img");if(o&&a.is("img")&&1>=s.find("img").length){var r=[],l=a.attr("class"),c=[];l&&(c=l.split(/\s+/));var d=a.attr("width"),g=a.attr("height");e.each(c,function(e,t){t.match(/size-/)||t.match(/align/)||t.match(/wp-image-/)||r.push(t)});m=null;if(s.is("img"))m=s;else var m=s.find("img");e.each(r,function(e,t){m.addClass(t)}),m.attr("height",g).attr("width",d);var b=e(tinymce.activeEditor.selection.getNode()),h=b.parent();if(h.length&&"A"==h[0].tagName&&(b=h),b.replaceWith(s[0].outerHTML),tinymce.activeEditor.fire("setContent"),tinymce.activeEditor.focus(),BOLDGRID.EDITOR.mce.undoManager.add(),window.tb_remove)try{window.tb_remove()}catch(e){}}else i.push(n),t&&t.apply(this,i)}},t.select_default_alignment(),t.original_column_val=e('[name="screen_columns"]:checked').val(),tinymce.PluginManager.add("add_block_imhwpb",function(e,t){"content"===e.id&&(e.addButton("add_block_imhwpb",{title:"Add Block",classes:"button-primary gridblock-icon"}),e.buttons.fullscreen.tooltip="Fullscreen (Ctrl+Shift+F)")}),tinymce.PluginManager.add("large_view_imhwpb",function(n,i){"content"===n.id&&n.addButton("large_view_imhwpb",{title:"Large View",icon:"icon dashicons dashicons-desktop imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-large",onclick:function(n){t.activate_display("large",e(n.target))}})}),tinymce.PluginManager.add("monitor_view_imhwpb",function(n,i){"content"===n.id&&n.addButton("monitor_view_imhwpb",{title:"Desktop View",icon:"icon dashicons dashicons-laptop imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-desktop",onclick:function(n){t.activate_display("monitor",e(n.target))}})}),tinymce.PluginManager.add("tablet_view_imhwpb",function(n,i){"content"===n.id&&n.addButton("tablet_view_imhwpb",{title:"Tablet View",icon:"icon dashicons dashicons-tablet imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-tablet",onclick:function(n){t.activate_display("tablet",e(n.target))}})}),tinymce.PluginManager.add("phone_view_imhwpb",function(n,i){"content"===n.id&&n.addButton("phone_view_imhwpb",{title:"Phone View",icon:"icon dashicons dashicons-smartphone imhwpb-icon",classes:"displaysize-imhwpb widget btn boldgrid-phone",onclick:function(n){t.activate_display("phone",e(n.target))}})}),tinymce.PluginManager.add("toggle_draggable_imhwpb",function(n,i){"content"===n.id&&(BOLDGRID.EDITOR.mce=n,t.override_insert_media(),n.addButton("toggle_draggable_imhwpb",{title:"BoldGrid Editing",icon:"icon genericon genericon-move",classes:"widget btn",onclick:t.toggle_draggable_plugin}),n.on("NodeChange",function(t){var n=e(t.element).html();e(t.element).is("td, th")&&n.includes("<br>")&&(n=n.replace("<br>",""),e(t.element).html(n))}),n.on("AfterSetSelectionRange",function(t){var i=t.range.startContainer,a=t.range.endContainer,s=e(i).is("td, th")||0<e(i).parents("td, th").length,o=e(a).is(i),r=e(i).closest("table"),l=e(a).closest("table").is(r);s&&!o&&(l||n.selection.select(i))}),n.on("SaveContent",function(t){var n=e("<div>"+t.content+"</div>");n.find(".td-resize-tooltip").remove(),t.content=n.html()}),n.on("BeforeAddUndo",function(e){if(1==IMHWPB.tinymce_undo_disabled)return!1;e.level.content=BG.Service.sanitize.cleanup(e.level.content)}),n.on("undo redo",function(t){BOLDGRID.EDITOR.Controls.$container&&BOLDGRID.EDITOR.Controls.$container.trigger("history_change_boldgrid"),"undefined"!=typeof IMHWPBGallery&&IMHWPBGallery.init_gallery&&IMHWPBGallery.init_gallery(e(n.iframeElement).contents())}),n.on("SetContent",function(n){t.reset_anchor_spaces(tinymce.activeEditor.getBody(),!0),t.adjust_overlay_colors(tinymce.activeEditor.getBody()),e.fourpan&&e.fourpan.refresh&&e.fourpan.refresh(),"html"==n.format&&t.dragging_is_active()&&!n.set&&IMHWPB.WP_MCE_Draggable.instance.draggable_instance.validate_markup()}),n.on("show",function(e){t.dragging_is_active()&&IMHWPB.WP_MCE_Draggable.instance.draggable_instance.validate_markup()}),n.on("KeyDown",function(i){if(!t.draggable)return!0;"Escape"===i.key&&n.execCommand("mceFullScreen");var a,s,o,r=tinymce.activeEditor.selection.getNode(),l=e(r);t.dragging_is_active()&&t.draggable.$master_container.trigger("is-typing-keydown");var c=l.is(t.draggable.column_selectors_string),d=l.hasClass("bg-box"),g=l.is(t.draggable.row_selectors_string),m=l.is("A"),b=tinymce.DOM.isEmpty(r);if(d&&13==i.which&&b)return a=e("<p><br></p>"),l.append(a),n.selection.setCursorLocation(a[0],0),!1;if(c||g){if(48<=i.which&&90>=i.which||96<=i.which&&105>=i.which||13==i.which){if(!b)return;if(13==i.which){if(g||c&&t.draggable.max_row_size===t.draggable.find_column_size(l))return a=e('<div class="row"><div class="col-lg-12 col-md-12"></div></div>'),l.closest(".row").after(a),n.selection.setCursorLocation(a.find(".col-md-12")[0],0),!1;if(c)return s=e('<p><br data-mce-bogus="1"></p><p><br data-mce-bogus="1"></p>'),l.append(s),n.selection.setCursorLocation(s.last()[0],0),!1}c?a=s=e('<p><br data-mce-bogus="1"></p>'):s=(a=e('<div class="col-lg-12 col-md-12"><p><br></p></div>')).find("p"),l.html(a),n.selection.setCursorLocation(s[0],0)}}else if(!m||"8"!=i.which&&"46"!=i.which){if("P"==r.tagName){if(13==i.which&&b&&!l.find("img").length)return s=e('<p><br data-mce-bogus="1"></p>'),l.after(s),n.selection.setCursorLocation(s[0],0),!1;if("8"==i.which&&b&&((o=l.prev()).length&&o.hasClass("draggable-tools-imhwpb")&&(o=o.prev()),o.length))return l.remove(),tinymce.DOM.isEmpty(o[0])?n.selection.setCursorLocation(o[0],0):(n.selection.select(o[0]),n.selection.collapse(0)),!1}else if(("IMG"==r.tagName||l.is(".button-primary, .button-secondary, .btn"))&&13==i.which){s=e('<p><br data-mce-bogus="1"></p>');var h=l.closest("p");return h.length?h.after(s):l.after(s),n.selection.setCursorLocation(s[0],0),!1}}else if("&nbsp;&nbsp;"==l.html()||"&nbsp; "==l.html())return l.remove(),!1;return!0}),n.on("NodeChange",function(t){var i=e(t.element);if("A"==t.element.tagName){var a=tinymce.DOM.createRng(),s=tinymce.activeEditor.selection.getRng(),o=null;if(s.startOffset==s.endOffset)if(0===s.startOffset)t.element.firstChild.data&&("&nbsp;"==t.element.firstChild.data.substr(0,6)||/\s/.test(t.element.firstChild.data.substr(0,1)))&&(o=1);else if(t.element.firstChild&&s.startOffset==t.element.firstChild.length){var r=0;t.element.firstChild.data&&("&nbsp;"==t.element.firstChild.data.substr(-6)||/\s/.test(t.element.firstChild.data.substr(-1)))&&(r=-1),o=t.element.firstChild.length+r}o&&(a.setStart(t.element.firstChild,o),a.setEnd(t.element.firstChild,o),tinymce.activeEditor.selection.setRng(a))}t.selectionChange&&i.length&&i.is("br")&&i.parent().children().each(function(){var t=e(this);if(t.is("a")&&t.html()&&!t.find("img").length)return $new_element=t.find(":first"),$new_element.length||($new_element=t),n.selection.setCursorLocation($new_element[0],1),!1})}),n.on("SetAttrib",function(e){if(e.attrElm.hasClass("wpview-wrap")&&void 0!==IMHWPB.WP_MCE_Draggable.instance){var t=IMHWPB.WP_MCE_Draggable.instance.draggable_instance;t.resize&&t.$master_container.trigger("mouseup",e.attrElm)}}),n.on("mousedown",function(n){if(t.draggable){var i,a=e(n.target),s=!0===tinymce.activeEditor.boldgridResize,o=a.closest(".draggable-tools-imhwpb").length,r=!t.draggable.ie_version&&a.hasClass("action-list")&&!a.attr("draggable");(o&&!r||s)&&(n.button=!0,n.preventDefault=function(){},(i=e("<div><div></div></div>"))[0].contentEditable=!1,n.target=i[0])}}),n.on("dragstart",function(t){e(t.originalTarget).hasClass("popover-imhwpb")&&t.preventDefault()}),n.on("ObjectResizeStart",function(e){void 0!==IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container&&(IMHWPB.WP_MCE_Draggable.instance.draggable_instance.popovers_disabled=!0,IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.find("html").addClass("bg-disabled-handles"))}),n.on("ObjectResized",function(e){void 0!==IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container&&(IMHWPB.WP_MCE_Draggable.instance.draggable_instance.popovers_disabled=!1,IMHWPB.WP_MCE_Draggable.instance.draggable_instance.$master_container.find("html").removeClass("bg-disabled-handles"))}),n.on("GetContent",function(n){var i=window.getUserSetting("editor_fullscreen");n.content&&(n.content=t.reset_anchor_spaces("<div>"+n.content+"</div>",!1),n.content=BG.Service.sanitize.cleanup(n.content),"on"===i&&e("#post-status-info").css({position:"fixed",bottom:-1e4}))}),n.on("AddUndo",function(e){BOLDGRID.EDITOR.GRIDBLOCK.View.updateHistoryStates(),BOLDGRID.EDITOR.Service.component&&BOLDGRID.EDITOR.Service.component.validateEditor()}),n.on("init",function(i){IMHWPB.WP_MCE_Draggable.instance=new IMHWPB.WP_MCE_Draggable;var a=e(n.getBody()),s=e(i.target.iframeElement).contents(),o=window.getUserSetting("editor_fullscreen");if(BoldgridEditor.global_inline_styles){var r=e('<style id="global-inline-styles"></style>'),l=BoldgridEditor.global_inline_styles,c=s.find("head");r.html(l),c.append(r)}"on"===o&&n.execCommand("mceFullScreen"),BoldgridEditor.body_class&&a.addClass(BoldgridEditor.body_class),BoldgridEditor.hasDraggableEnabled?(IMHWPB.WP_MCE_Draggable.instance.load_draggable(s),t.draggable=IMHWPB.WP_MCE_Draggable.instance.draggable_instance,t.draggable.ie_version&&11>=t.draggable.ie_version&&a.addClass("dragging-disabled")):(IMHWPB.WP_MCE_Draggable.instance.draggable_inactive=!0,IMHWPB.WP_MCE_Draggable.instance.addDeactivateClasses());var d=[];d.push(tinymce.ui.Factory.create({type:"button",title:"Change",tooltip:"Change",icon:"icon dashicons dashicons-admin-media imhwpb-icon",onclick:function(){BOLDGRID.EDITOR.CONTROLS.IMAGE.Change.openModal()}})),tinymce.activeEditor.on("wptoolbar",function(e){if(e.toolbar){var t=e.toolbar,n=t.items()[0].items()[0],i=_.findIndex(n.items(),function(e){return"Change"==e.settings.title});t.show(),-1===i&&(n.insert(d,3,!1),t.reposition())}}),tinymce.activeEditor.on("FullscreenStateChanged",function(t){if($wpStatusbar=e("#post-status-info"),t.state){window.setUserSetting("editor_fullscreen","on");var n=parseInt(e("#wpadminbar").css("z-index"))+1;e(window).trigger("resize"),e("#post-body-content").attr("style","position:relative;z-index:"+n+" !important;"),$wpStatusbar.css({position:"fixed",bottom:-1e4})}else window.setUserSetting("editor_fullscreen","off"),e("#post-body-content").attr("style","position:relative;"),$wpStatusbar.css({position:"unset",bottom:"unset"})}),[e("i.mce-i-bold").parent("button").parent(".mce-widget"),e("i.mce-i-bullist").parent("button").parent(".mce-widget"),e("i.mce-i-alignleft").parent("button").parent(".mce-widget"),e("i.mce-i-link").parent("button").parent(".mce-widget"),e("i.mce-i-icon.dashicons-desktop").parent("button").parent(".mce-widget"),e("i.mce-i-strikethrough").parent("button").parent(".mce-widget")].forEach(function(t){e('<div class="mce-divider"></div>').insertBefore(e(t)),window.boldgridEditorPointers&&e(".mce-i-fullscreen").pointer(options).pointer("reposition")}),e("#wp-content-editor-container > .mce-tinymce > .mce-container-body > .mce-top-part > .mce-container-body").prepend('<div id="mce_fullscreen_actions"></div>'),e("#mce_fullscreen_actions").append(e("#wp-content-media-buttons").clone(!0)),e("#mce_fullscreen_actions").append('<div class="mce-publish-buttons"></div>'),e(".mce-publish-buttons").append(e("#minor-publishing-actions").clone(!0).prop("id","mce-minor-publishing-actions")),e(".mce-publish-buttons").append(e("#major-publishing-actions").clone(!0).prop("id","mce-major-publishing-actions")),e(".mce-publish-buttons").append('<div class="mce-close-fullscreen"><span class="dashicons dashicons-no-alt"></span></div>'),e(".mce-close-fullscreen").on("click",function(){n.execCommand("mceFullScreen")})}))}),this.mce_element_is_empty=function(e){var t=e.children(),n=!1;return(e.is(":empty")||1==t.length&&t.filter("br").length&&!e.text())&&(n=!0),n},this.adjust_overlay_colors=function(t){var n=e(t),i=n.find("[data-bg-overlaycolor-alpha]");return $alphaBgElements=n.find("[data-alpha]"),$alphaBgElements.each(function(){var t,n,i=e(this),a=i.attr("class").match(/color[\d|\-|\w]*-background-color/),s=i.attr("data-bg-uuid"),o=i.attr("data-alpha"),r=e(tinyMCE.activeEditor.iframeElement).contents().find("head");a&&(t="background-color: "+("neutral"!==(n=(n=a[0].replace("color","").replace("-background-color","")).replace("-",""))?BoldgridEditor.colors.defaults[parseInt(n)-1]:BoldgridEditor.colors.neutral).replace(")",","+o+")").replace("rgb","rgba")+" !important;",r.append('<style id="'+s+'-inline-styles">body .'+s+" { "+t+" }</style>"))}),i.each(function(){var t,n,i=e(this),a=i.data("bg-overlaycolor-class"),s=i.data("bg-overlaycolor-alpha"),o=i.data("image-url");n=(n=(n="neutral"!==a?BoldgridEditor.colors.defaults[parseInt(a)-1]:BoldgridEditor.colors.neutral).replace(")",","+s+")")).replace("rgb","rgba"),i.attr("data-bg-overlaycolor",n),t="linear-gradient(to left, "+n+", "+n+'), url("'+o+'")',i.css("background-image",t)}),n.html()},this.reset_anchor_spaces=function(t,n){var i=e(t);return i.find("a:not(.wpview a)").each(function(){var t=e(this),i=t.html();"&nbsp;"==i.substr(0,6)&&(i=i.substr(6)),"&nbsp;"==i.substr(-6,6)&&(i=i.substr(0,i.length-6)),n?(t.hasClass("btn")||t.hasClass("button")||t.hasClass("button-primary")||t.hasClass("button-secondary")||t.hasClass("ppb-button"))&&t.html("&nbsp;"+i+"&nbsp;"):t.html(i)}),i.html()},this.dragging_is_active=function(){return void 0!==IMHWPB.WP_MCE_Draggable.instance&&0==IMHWPB.WP_MCE_Draggable.instance.draggable_inactive},this.toggle_draggable_plugin=function(e){console.log("disabled")},this.activate_display=function(i,a){var s=a.closest("div");if(s.hasClass("mce-disabled"))return!1;e(".mce-displaysize-imhwpb").removeClass("boldgrid-highlighted-mce-icon"),s.hasClass("mce-active")?(a.closest("div").removeClass("mce-active"),t.remove_editor_styles(),t.currently_selected_size=null):(e(".mce-displaysize-imhwpb").each(function(){e(this).closest("div").removeClass("mce-active")}),a.closest("div").addClass("mce-active"),t.set_width(i),t.currently_selected_size=i),IMHWPB.WP_MCE_Draggable.instance&&0==IMHWPB.WP_MCE_Draggable.instance.draggable_inactive&&(IMHWPB.WP_MCE_Draggable.instance.resize_done_event(),n.trigger("resize"))},this.remove_editor_styles=function(){e("#content_ifr").removeClass("mce-viewsize-phone-imhwpb mce-viewsize-tablet-imhwpb mce-viewsize-monitor-imhwpb mce-viewsize-large-imhwpb")},this.set_width=function(n){t.remove_editor_styles(),e("#content_ifr").addClass("mce-viewsize-"+n+"-imhwpb")}},IMHWPB.Editor.instance=new IMHWPB.Editor(jQuery);
